import telebot
from telebot import types
import random
import time
import json
import os
import re

bot = telebot.TeleBot("8060494113:AAEHrZqYKxK2TxQ1ZVYRpW7s76QlS15WSEQ")

# ------------------------------
# –§–∞–π–ª –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
# ------------------------------
DATA_FILE = "data.json"

def save_data():
    with open(DATA_FILE, "w", encoding="utf-8") as f:
        json.dump(users, f, ensure_ascii=False, indent=4)

def load_data():
    global users, custom_cards_all, new_year_cards_all
    if os.path.exists(DATA_FILE):
        with open(DATA_FILE, "r", encoding="utf-8") as f:
            users = json.load(f)
    else:
        users = {}

    custom_cards_all = []
    new_year_cards_all = []
    for user_data in users.values():
        for card in user_data.get('custom_cards', []):
            custom_cards_all.append(card)
        for card in user_data.get('new_year_cards', []):
            new_year_cards_all.append(card)

# ------------------------------
# –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
# ------------------------------
users = {}
custom_cards_all = []
new_year_cards_all = []

load_data()

# ------------------------------
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±—ã—á–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
# ------------------------------
rarities_normal = {
    "–æ–±—ã—á–Ω—ã–π": {"stars": 2, "points": 100, "emoji": "‚≠ê", "chance": 40},
    "—Ä–µ–¥–∫–∏–π": {"stars": 3, "points": 250, "emoji": "üåü", "chance": 25},
    "—Å–≤–µ—Ä—Ö—Ä–µ–¥–∫–∏–π": {"stars": 4, "points": 400, "emoji": "üî•", "chance": 15},
    "—ç–ø–∏—á–µ—Å–∫–∏–π": {"stars": 5, "points": 500, "emoji": "üíé", "chance": 10},
    "–º–∏—Ñ–∏—á–µ—Å–∫–∏–π": {"stars": 6, "points": 750, "emoji": "üí´", "chance": 6},
    "–ª–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π": {"stars": 7, "points": 900, "emoji": "üëë", "chance": 3},
    "—Å–µ–∫—Ä–µ—Ç–Ω—ã–π": {"stars": 8, "points": 1250, "emoji": "üõ°Ô∏è", "chance": 1}
}

def get_random_rarity():
    rarities = list(rarities_normal.keys())
    weights = [rarities_normal[r]["chance"] for r in rarities]
    return random.choices(rarities, weights=weights, k=1)[0]

names_normal = {
    "–æ–±—ã—á–Ω—ã–π": ["Moonlit", "21", "Generic Platformer", "skill test 01"],
    "—Ä–µ–¥–∫–∏–π": ["Moroznie Cvetochki", "more okean i palmi"],
    "—Å–≤–µ—Ä—Ö—Ä–µ–¥–∫–∏–π": ["Ice age", "tuchencia", "fireblood"],
    "—ç–ø–∏—á–µ—Å–∫–∏–π": ["Die in a fire", "xiaomi hyper os"],
    "–º–∏—Ñ–∏—á–µ—Å–∫–∏–π": ["3000", "poison temple"],
    "–ª–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π": ["Kurilka", "kocmoc 2"],
    "—Å–µ–∫—Ä–µ—Ç–Ω—ã–π": ["KOKMOK", "cristal wnm1"]
}

# ------------------------------
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –∫–∞—Ä—Ç
# ------------------------------
custom_raters = {
    "—Å—Ç–∞—Ä —Ä–µ–π—Ç": 0,
    "—Ñ–∏—á–µ—Ä": 200,
    "—ç–ø–∏–∫": 500,
    "–º–∏—Ñ–∏–∫": 800,
    "–õ–µ–≥–∞": 1250
}

# ------------------------------
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–æ–≤–æ–≥–æ–¥–Ω–∏—Ö –∫–∞—Ä—Ç
# ------------------------------
new_year_themes = {
    "‚ùÑ –°–Ω–µ–∂–∏–Ω–∫–∞": 1,
    "üéÑ –Å–ª–∫–∞": 2,
    "üéÖ –î–µ–¥ –ú–æ—Ä–æ–∑": 3,
    "üéÅ –ü–æ–¥–∞—Ä–æ–∫": 4,
    "‚ú® –ì–∏—Ä–ª—è–Ω–¥–∞": 5,
    "üåü –ó–≤—ë–∑–¥–Ω–∞—è –∫–æ–º–µ—Ç–∞": 6
}

new_year_rarities = {
    "–æ–±—ã—á–Ω–∞—è": {"stars":2, "bonus":1, "chance": 40},
    "—Ä–µ–¥–∫–∞—è": {"stars":3, "bonus":2, "chance": 25},
    "—ç–ø–∏—á–µ—Å–∫–∞—è": {"stars":4, "bonus":3, "chance": 15},
    "–º–∏—Ñ–∏—á–µ—Å–∫–∞—è": {"stars":5, "bonus":4, "chance": 10},
    "–ª–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è": {"stars":6, "bonus":5, "chance": 7},
    "—Å–µ–∫—Ä–µ—Ç–Ω–∞—è": {"stars":7, "bonus":6, "chance": 3}
}

def get_random_new_year_rarity():
    rarities = list(new_year_rarities.keys())
    weights = [new_year_rarities[r]["chance"] for r in rarities]
    return random.choices(rarities, weights=weights, k=1)[0]

# ------------------------------
# –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –∏ –∑–∞—â–∏—â—ë–Ω–Ω—ã–µ –Ω–∏–∫–∏
# ------------------------------
ADMIN_USERS = {
    "5967087017": "üëë"
}

RESERVED_NICKS = ["kitten97"]

def has_emoji(text):
    emoji_pattern = re.compile(
        "[\U0001F600-\U0001F64F"
        "\U0001F300-\U0001F5FF"
        "\U0001F680-\U0001F6FF"
        "\U0001F1E0-\U0001F1FF"
        "]+", flags=re.UNICODE
    )
    return bool(emoji_pattern.search(text))

def get_display_nick(user_id, nick):
    if str(user_id) in ADMIN_USERS:
        return f"{nick} {ADMIN_USERS[str(user_id)]}"
    return nick

def is_nick_reserved(nick):
    return nick.lower() in RESERVED_NICKS

# ------------------------------
# –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
# ------------------------------
def get_user_data(user_id):
    if str(user_id) not in users:
        users[str(user_id)] = {
            'nick':'', 'awaiting_nick': True,
            'last_card_time':0, 'cards':[],
            'custom_cards':[], 'last_custom_time':0, 'custom_points':0,
            'new_year_cards':[], 'last_new_year':0, 'total_snowflakes':0,
            'awaiting_custom':False, 'awaiting_new_year':False
        }
        save_data()
    return users[str(user_id)]

# ------------------------------
# –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
# ------------------------------
def main_menu(chat_id, user_name, user_id=None):
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
    markup.add("–û—Ç–∫—Ä—ã—Ç—å", "–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å", "–õ–∏–¥–µ—Ä—ã")
    markup.add("–°–æ–∑–¥–∞—Ç—å –∫–∞—Å—Ç–æ–º–Ω—É—é –∫–∞—Ä—Ç—É", "–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ–¥–Ω—é—é –∫–∞—Ä—Ç–æ—á–∫—É")
    markup.add("–õ–∏–¥–µ—Ä—ã –ö—Ä–µ–∞—Ç–æ—Ä–æ–≤", "–õ—É—á—à–∏–µ –∫–∞—Å—Ç–æ–º–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏")
    markup.add("–õ–∏–¥–µ—Ä—ã –∏–≤–µ–Ω—Ç–∞", "–õ—É—á—à–∏–µ –Ω–æ–≤–æ–≥–æ–¥–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏")
    markup.add("–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ")  # –î–æ–±–∞–≤–∏–ª–∏ –∫–Ω–æ–ø–∫—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

    display_name = get_display_nick(user_id, user_name)
    bot.send_message(chat_id, f"‚ú® –ü—Ä–∏–≤–µ—Ç {display_name}! –°–ø–∞—Å–∏–±–æ, —á—Ç–æ –ø–æ–ª—å–∑—É–µ—à—å—Å—è –±–æ—Ç–æ–º ;)", reply_markup=markup)

# ------------------------------
# –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
# ------------------------------
admin_state = {}  # user_id ‚Üí —Å–æ—Å—Ç–æ—è–Ω–∏–µ
ADMIN_PASSWORD = "zelszels86"

def admin_menu(message):
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
    markup.add("–û–±–Ω—É–ª–∏—Ç—å –∏–≥—Ä–æ–∫–∞", "–ò–∑–º–µ–Ω–∏—Ç—å –∏–º—è")
    markup.add("–î–æ–±–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω–∞")
    markup.add("–ù–∞–∑–∞–¥")
    bot.send_message(message.chat.id, "üîß –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:", reply_markup=markup)

# ------------------------------
# –§—É–Ω–∫—Ü–∏–∏ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
# ------------------------------
def reset_player(nick):
    for uid, data in users.items():
        if data.get("nick", "").lower() == nick.lower():
            users[uid] = {
                'nick': '',
                'awaiting_nick': True,
                'last_card_time': 0,
                'cards': [],
                'custom_cards': [],
                'last_custom_time': 0,
                'custom_points': 0,
                'new_year_cards': [],
                'last_new_year': 0,
                'total_snowflakes': 0,
                'awaiting_custom': False,
                'awaiting_new_year': False
            }
            save_data()
            return True
    return False

def change_nick(old_nick, new_nick):
    for uid, data in users.items():
        if data.get("nick", "").lower() == old_nick.lower():
            data["nick"] = new_nick
            save_data()
            return True
    return False

def add_admin(user_id):
    ADMIN_USERS[str(user_id)] = "üëë"
    save_data()

# ------------------------------
# –û—Ç–∫—Ä—ã—Ç–∏–µ –æ–±—ã—á–Ω–æ–π –∫–∞—Ä—Ç—ã
# ------------------------------
def open_card(message):
    user_id = message.from_user.id
    data = get_user_data(user_id)
    now = time.time()

    if now - data['last_card_time'] < 3600:
        remaining = int((3600 - (now - data['last_card_time'])) // 60)
        bot.send_message(message.chat.id, f"‚è≥ –ü–æ–¥–æ–∂–¥–∏ {remaining} –º–∏–Ω—É—Ç –¥–æ –Ω–æ–≤–æ–π –∫–∞—Ä—Ç—ã.")
        return

    rarity = get_random_rarity()
    name = random.choice(names_normal[rarity])
    stars = rarities_normal[rarity]['stars']
    points = rarities_normal[rarity]['points']
    emoji = rarities_normal[rarity]['emoji']

    found = any(c['name'] == name for c in data['cards'])
    if found:
        points += int(points * 0.1)
        msg_extra = "üîÑ –ü–æ–≤—Ç–æ—Ä–∫–∞! –ü–æ–ª—É—á–µ–Ω—ã –±–æ–Ω—É—Å–Ω—ã–µ –æ—á–∫–∏."
    else:
        msg_extra = "üÜï –ù–æ–≤–∞—è –∫–∞—Ä—Ç–∞!"

    card = {"name":name, "rarity":rarity, "stars":stars, "points":points, "emoji":emoji}
    data['cards'].append(card)
    data['last_card_time'] = now
    save_data()

    bot.send_message(message.chat.id,
        f"{emoji} {rarity.title()} –∫–∞—Ä—Ç–∞!\n"
        f"–ò–º—è: {name}\n"
        f"–ó–≤—ë–∑–¥—ã: {stars}\n"
        f"–û—á–∫–∏: {points}\n"
        f"{msg_extra}"
    )

# ------------------------------
# –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω–æ–π –∫–∞—Ä—Ç—ã
# ------------------------------
def create_custom_card(message):
    user_id = message.from_user.id
    data = get_user_data(user_id)
    now = time.time()

    if now - data['last_custom_time'] < 86400:
        remaining = int((86400 - (now - data['last_custom_time'])) // 3600)
        bot.send_message(message.chat.id, f"‚è≥ –ö–∞—Å—Ç–æ–º–Ω–∞—è –∫–∞—Ä—Ç–∞ —É–∂–µ —Å–æ–∑–¥–∞–Ω–∞ —Å–µ–≥–æ–¥–Ω—è. –ü–æ–¥–æ–∂–¥–∏ {remaining} —á–∞—Å–æ–≤.")
        return

    data['awaiting_custom'] = True
    bot.send_message(message.chat.id, "–í–≤–µ–¥–∏—Ç–µ –∏–º—è –≤–∞—à–µ–π –∫–∞—Å—Ç–æ–º–Ω–æ–π –∫–∞—Ä—Ç—ã:")

def handle_custom_name(message):
    user_id = message.from_user.id
    data = get_user_data(user_id)

    name = message.text.strip()
    rarity = get_random_rarity()
    stars = rarities_normal[rarity]['stars']
    base_points = rarities_normal[rarity]['points']
    rate_name, rate_points = random.choice(list(custom_raters.items()))
    total_points = base_points + rate_points

    card = {
        "name":name, "rarity":rarity, "stars":stars,
        "points":total_points, "rate":rate_name, "owner":data['nick']
    }

    data['custom_cards'].append(card)
    data['custom_points'] += total_points
    custom_cards_all.append(card)
    data['last_custom_time'] = time.time()
    data['awaiting_custom'] = False
    save_data()

    bot.send_message(message.chat.id,
        f"üé® –ö–∞—Å—Ç–æ–º–Ω–∞—è –∫–∞—Ä—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞!\n"
        f"–ò–º—è: {name}\n"
        f"–†–µ–¥–∫–æ—Å—Ç—å: {rarity}\n"
        f"–ó–≤—ë–∑–¥—ã: {stars}\n"
        f"–†–µ–π—Ç: {rate_name}\n"
        f"–û—á–∫–∏: {total_points}"
    )

# ------------------------------
# –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ–¥–Ω–µ–π –∫–∞—Ä—Ç—ã
# ------------------------------
def create_new_year_card(message):
    user_id = message.from_user.id
    data = get_user_data(user_id)
    now = time.time()

    if now - data['last_new_year'] < 86400:
        remaining = int((86400 - (now - data['last_new_year'])) // 3600)
        bot.send_message(message.chat.id, f"‚è≥ –ù–æ–≤–æ–≥–æ–¥–Ω—è—è –∫–∞—Ä—Ç–∞ —É–∂–µ —Å–æ–∑–¥–∞–Ω–∞ —Å–µ–≥–æ–¥–Ω—è. –ü–æ–¥–æ–∂–¥–∏ {remaining} —á–∞—Å–æ–≤.")
        return

    data['awaiting_new_year'] = True
    bot.send_message(message.chat.id, "–í–≤–µ–¥–∏—Ç–µ –∏–º—è –≤–∞—à–µ–π –Ω–æ–≤–æ–≥–æ–¥–Ω–µ–π –∫–∞—Ä—Ç–æ—á–∫–∏:")

def handle_new_year_name(message):
    user_id = message.from_user.id
    data = get_user_data(user_id)

    name = message.text.strip()
    theme = random.choice(list(new_year_themes.keys()))
    theme_points = new_year_themes[theme]

    rarity_name = get_random_new_year_rarity()
    rarity_stars = new_year_rarities[rarity_name]['stars']
    rarity_points = new_year_rarities[rarity_name]['bonus']

    total_points = theme_points + rarity_points

    card = {
        "name":name, "theme":theme, "rarity":rarity_name,
        "stars":rarity_stars, "points":total_points, "owner":data['nick']
    }

    data['new_year_cards'].append(card)
    data['total_snowflakes'] += total_points
    data['last_new_year'] = time.time()
    new_year_cards_all.append(card)
    data['awaiting_new_year'] = False
    save_data()

    bot.send_message(message.chat.id,
        f"üéÑ –ù–æ–≤–æ–≥–æ–¥–Ω—è—è –∫–∞—Ä—Ç–æ—á–∫–∞ —Å–æ–∑–¥–∞–Ω–∞!\n"
        f"–ò–º—è: {name}\n"
        f"–¢–µ–º–∞: {theme}\n"
        f"–†–µ–¥–∫–æ—Å—Ç—å: {rarity_name}\n"
        f"–ó–≤—ë–∑–¥—ã: {rarity_stars}\n"
        f"–û—á–∫–∏ –Ω–æ–≤–æ–≥–æ–¥–Ω–µ–π –∫–∞—Ä—Ç—ã: {total_points}"
    )

# ------------------------------
# –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å
# ------------------------------
def show_inventory(message):
    user_id = message.from_user.id
    data = get_user_data(user_id)

    msg = "üÉè –í–∞—à –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å:\n\n"

    if data['cards']:
        msg += "üîπ –û–±—ã—á–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏:\n"
        for c in data['cards']:
            msg += f"{c['emoji']} {c['name']} ({c['rarity']}, ‚≠ê {c['stars']}, –æ—á–∫–∏ {c['points']})\n"
    else:
        msg += "–û–±—ã—á–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ –Ω–µ—Ç.\n"

    if data['custom_cards']:
        msg += "\nüé® –ö–∞—Å—Ç–æ–º–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏:\n"
        for c in data['custom_cards']:
            msg += f"{c['name']} ({c['rarity']}, ‚≠ê {c['stars']}, —Ä–µ–π—Ç {c['rate']}, –æ—á–∫–∏ {c['points']})\n"
    else:
        msg += "\n–ö–∞—Å—Ç–æ–º–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ –Ω–µ—Ç.\n"

    if data['new_year_cards']:
        msg += "\nüéÑ –ù–æ–≤–æ–≥–æ–¥–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏:\n"
        for c in data['new_year_cards']:
            msg += f"{c['name']} ({c['theme']}, {c['rarity']}, ‚≠ê {c['stars']}, –æ—á–∫–∏ {c['points']})\n"
    else:
        msg += "\n–ù–æ–≤–æ–≥–æ–¥–Ω–∏—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ –Ω–µ—Ç.\n"

    markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
    markup.add("–ù–∞–∑–∞–¥")
    bot.send_message(message.chat.id, msg, reply_markup=markup)

# ------------------------------
# –õ–∏–¥–µ—Ä—ã
# ------------------------------
def show_leaders(message):
    top = sorted(
        users.items(),
        key=lambda x: sum(c['points'] for c in x[1].get('cards', [])),
        reverse=True
    )[:10]

    msg = "üèÜ –õ–∏–¥–µ—Ä—ã –ø–æ –æ—á–∫–∞–º:\n"
    for i, (uid, u) in enumerate(top, start=1):
        nick = get_display_nick(uid, u.get('nick', '–ë–µ–∑ –Ω–∏–∫–∞'))
        score = sum(c['points'] for c in u.get('cards', []))
        msg += f"#{i} {nick} ‚Äî {score} –æ—á–∫–æ–≤\n"

    markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
    markup.add("–ù–∞–∑–∞–¥")
    bot.send_message(message.chat.id, msg, reply_markup=markup)

def show_creators(message):
    top = sorted(
        users.items(),
        key=lambda x: x[1].get('custom_points', 0),
        reverse=True
    )[:10]

    msg = "üèÜ –õ–∏–¥–µ—Ä—ã –ö—Ä–µ–∞—Ç–æ—Ä–æ–≤:\n"
    for i, (uid, u) in enumerate(top, start=1):
        nick = get_display_nick(uid, u.get('nick', '–ë–µ–∑ –Ω–∏–∫–∞'))
        msg += f"#{i} {nick} ‚Äî {u.get('custom_points', 0)} –ö—Ä–µ–∞—Ç–æ—Ä –ü–æ–∏–Ω—Ç–æ–≤\n"

    markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
    markup.add("–ù–∞–∑–∞–¥")
    bot.send_message(message.chat.id, msg, reply_markup=markup)

def show_best_custom_cards(message):
    top = sorted(custom_cards_all, key=lambda c: c['points'], reverse=True)[:10]

    msg = "üèÜ –õ—É—á—à–∏–µ –∫–∞—Å—Ç–æ–º–Ω—ã–µ –∫–∞—Ä—Ç—ã:\n"
    for i, c in enumerate(top, start=1):
        msg += f"#{i} {c['name']} ({c['rarity']}, ‚≠ê {c['stars']}, —Ä–µ–π—Ç {c['rate']}, –æ—á–∫–∏ {c['points']})\n"

    markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
    markup.add("–ù–∞–∑–∞–¥")
    bot.send_message(message.chat.id, msg, reply_markup=markup)

def show_new_year_leaders(message):
    top = sorted(
        users.items(),
        key=lambda x: x[1].get('total_snowflakes', 0),
        reverse=True
    )[:10]

    msg = "üèÜ –õ–∏–¥–µ—Ä—ã –∏–≤–µ–Ω—Ç–∞:\n"
    for i, (uid, u) in enumerate(top, start=1):
        nick = get_display_nick(uid, u.get('nick', '–ë–µ–∑ –Ω–∏–∫–∞'))
        msg += f"#{i} {nick} ‚Äî {u.get('total_snowflakes', 0)} —Å–Ω–µ–∂–∏–Ω–æ–∫\n"

    markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
    markup.add("–ù–∞–∑–∞–¥")
    bot.send_message(message.chat.id, msg, reply_markup=markup)

def show_best_new_year_cards(message):
    top = sorted(new_year_cards_all, key=lambda c: c['points'], reverse=True)[:10]

    msg = "üèÜ –õ—É—á—à–∏–µ –Ω–æ–≤–æ–≥–æ–¥–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏:\n"
    for i, c in enumerate(top, start=1):
        msg += (
            f"#{i} –∏–º—è:{c['name']} —Ç–µ–º–∞:{c['theme']} "
            f"—Ä–µ–¥–∫–æ—Å—Ç—å:{c['rarity']} ‚≠ê{c['stars']} –æ—á–∫–∏:{c['points']}\n"
        )

    markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
    markup.add("–ù–∞–∑–∞–¥")
    bot.send_message(message.chat.id, msg, reply_markup=markup)

def go_back(message):
    uid = message.from_user.id
    data = get_user_data(uid)
    main_menu(message.chat.id, data['nick'], uid)

# ------------------------------
# /start
# ------------------------------
@bot.message_handler(commands=["start"])
def start_command(message):
    uid = message.from_user.id
    data = get_user_data(uid)

    if data['nick'] == '':
        data['awaiting_nick'] = True
        save_data()
        bot.send_message(message.chat.id, "–ü—Ä–∏–≤–µ—Ç! –ù–∞–ø–∏—à–∏ —Å–≤–æ–π –Ω–∏–∫:")
    else:
        main_menu(message.chat.id, data['nick'], uid)

# ------------------------------
# –û—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–∞
# ------------------------------
@bot.message_handler(func=lambda m: True)
def handle_text(message):
    uid = message.from_user.id
    data = get_user_data(uid)
    text = message.text.lower()

    # === –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥–º–∏–Ω—Å–∫–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è ===
    state = admin_state.get(uid, "")

    # –í–≤–æ–¥ –ø–∞—Ä–æ–ª—è
    if state == "await_password":
        if message.text == ADMIN_PASSWORD:
            admin_state[uid] = "access_granted"
            admin_menu(message)
        else:
            bot.send_message(message.chat.id, "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!")
            admin_state[uid] = None
        return

    # –û–±–Ω—É–ª–µ–Ω–∏–µ
    if state == "reset_player":
        nick = message.text.strip()
        admin_state[uid] = None
        if reset_player(nick):
            bot.send_message(message.chat.id, f"–ò–≥—Ä–æ–∫ '{nick}' –æ–±–Ω—É–ª—ë–Ω.")
        else:
            bot.send_message(message.chat.id, f"–ò–≥—Ä–æ–∫ '{nick}' –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        return

    # –ò–∑–º–µ–Ω–∏—Ç—å –∏–º—è ‚Äî —Å—Ç–∞—Ä–æ–µ –∏–º—è
    if state == "change_old":
        admin_state[uid] = {"mode": "change_new", "old": message.text.strip()}
        bot.send_message(message.chat.id, "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è:")
        return

    # –ò–∑–º–µ–Ω–∏—Ç—å –∏–º—è ‚Äî –Ω–æ–≤–æ–µ
    if isinstance(state, dict) and state.get("mode") == "change_new":
        old = state["old"]
        new = message.text.strip()
        admin_state[uid] = None
        if change_nick(old, new):
            bot.send_message(message.chat.id, f"–ò–º—è –∏–∑–º–µ–Ω–µ–Ω–æ: {old} ‚Üí {new}")
        else:
            bot.send_message(message.chat.id, f"–ò–≥—Ä–æ–∫ '{old}' –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        return

    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞
    if state == "add_admin":
        admin_state[uid] = None
        try:
            add_admin(int(message.text))
            bot.send_message(message.chat.id, f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {message.text} —Ç–µ–ø–µ—Ä—å –∞–¥–º–∏–Ω.")
        except:
            bot.send_message(message.chat.id, "ID –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ–º.")
        return

    # ------------------------------
    # –û–±—ã—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
    # ------------------------------
    if data.get('awaiting_nick'):
        nick = message.text.strip()

        if has_emoji(nick):
            bot.send_message(message.chat.id, "–í –Ω–∏–∫–µ –Ω–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç–º–æ–¥–∑–∏!")
            return

        if is_nick_reserved(nick) and str(uid) != "5967087017":
            bot.send_message(message.chat.id, "–≠—Ç–æ—Ç –Ω–∏–∫ –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω!")
            return

        if nick.lower() in [u.get('nick','').lower() for u in users.values()]:
            bot.send_message(message.chat.id, "–≠—Ç–æ—Ç –Ω–∏–∫ —É–∂–µ –∑–∞–Ω—è—Ç!")
            return

        data['nick'] = nick
        data['awaiting_nick'] = False
        save_data()
        bot.send_message(message.chat.id, f"–û—Ç–ª–∏—á–Ω–æ, {nick}! –¢–µ–ø–µ—Ä—å —Ç—ã –≤ –∏–≥—Ä–µ.")
        main_menu(message.chat.id, nick, uid)

    elif data.get('awaiting_custom'):
        handle_custom_name(message)

    elif data.get('awaiting_new_year'):
        handle_new_year_name(message)

    elif text == "–æ—Ç–∫—Ä—ã—Ç—å":
        open_card(message)

    elif text == "—Å–æ–∑–¥–∞—Ç—å –∫–∞—Å—Ç–æ–º–Ω—É—é –∫–∞—Ä—Ç—É":
        create_custom_card(message)

    elif text == "—Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ–¥–Ω—é—é –∫–∞—Ä—Ç–æ—á–∫—É":
        create_new_year_card(message)

    elif text == "–∏–Ω–≤–µ–Ω—Ç–∞—Ä—å":
        show_inventory(message)

    elif text == "–ª–∏–¥–µ—Ä—ã":
        show_leaders(message)

    elif text == "–ª–∏–¥–µ—Ä—ã –∫—Ä–µ–∞—Ç–æ—Ä–æ–≤":
        show_creators(message)

    elif text == "–ª—É—á—à–∏–µ –∫–∞—Å—Ç–æ–º–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏":
        show_best_custom_cards(message)

    elif text == "–ª–∏–¥–µ—Ä—ã –∏–≤–µ–Ω—Ç–∞":
        show_new_year_leaders(message)

    elif text == "–ª—É—á—à–∏–µ –Ω–æ–≤–æ–≥–æ–¥–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏":
        show_best_new_year_cards(message)

    elif text == "–Ω–∞–∑–∞–¥":
        go_back(message)

    elif text == "—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ":
        admin_state[uid] = "await_password"
        bot.send_message(message.chat.id, "–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å:")

    elif text == "–æ–±–Ω—É–ª–∏—Ç—å –∏–≥—Ä–æ–∫–∞":
        admin_state[uid] = "reset_player"
        bot.send_message(message.chat.id, "–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫ –∏–≥—Ä–æ–∫–∞:")

    elif text == "–∏–∑–º–µ–Ω–∏—Ç—å –∏–º—è":
        admin_state[uid] = "change_old"
        bot.send_message(message.chat.id, "–í–≤–µ–¥–∏—Ç–µ —Å—Ç–∞—Ä–æ–µ –∏–º—è –∏–≥—Ä–æ–∫–∞:")

    elif text == "–¥–æ–±–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω–∞":
        admin_state[uid] = "add_admin"
        bot.send_message(message.chat.id, "–í–≤–µ–¥–∏—Ç–µ ID –Ω–æ–≤–æ–≥–æ –∞–¥–º–∏–Ω–∞:")

    else:
        bot.send_message(message.chat.id, "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é!")

# ------------------------------
# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
# ------------------------------
if __name__ == "__main__":
    print("Bot is starting...")
    bot.polling(none_stop=True)
